pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
-- menu!
autostart=true
levelid=1

function menu_update()
	if (btn(❎) or autostart) begin_game(levelid)
end

function menu_draw()
	cls(0)
	?"press ❎ to start"
end

-->8
-- game!

types={
	{sp=0}, -- 1: root bomb
	{sp=10} -- 2: blade
}

-- state
pl={x=64,y=64}
levels={
	{0,0,16,16}
}
mdata=nil
--1=planning,2=sim
phase=1
bmb={rad=8,id=1}

function set_level(id)
	mdata=levels[id]
	mdata.minx=10
	mdata.miny=10
	mdata.maxx=mdata[3]*8-10
	mdata.maxy=mdata[4]*8-10
	bmb.x=(mdata.minx+mdata.maxx)/2
	bmb.y=(mdata.miny+mdata.maxy)/2
	bmb.cld={}
	phase=1
end

-- cb
function begin_game(id)
	gstate=2
	set_level(id)
end

function bmb_to_list()
	local lst={bmb}
	local idx=1
	
	while (idx<=#lst) do
		local cur=lst[idx]
		
		for v in all(cur.cld) do
			add(lst,v)
			local offset=cur.rad+v.rad
			v.x=cur.x+offset*cos(v.rot)
			v.y=cur.y+offset*sin(v.rot)
			v.ax=cur.x+cur.rad*cos(v.rot)
			v.ay=cur.y+cur.rad*sin(v.rot)
		end
		
		idx+=1
	end
	
	return lst
end

function fnd_tgt()
	local lst=bmb_to_list()
	for cand in all(lst) do
		local range=dist(cand.x,cand.y,pl.x,pl.y)
		if range<cand.rad then
			return cand
		end
	end
	
	return nil
end

target=nil
selected=nil
function pln_update()
	target = fnd_tgt()
	if target!=nil then
		dbg("target:found")
	end
	
	if selected==nil then
		if target!=nil and rel_btn(❎) then
			local att={
				id=2,
				rad=4,
				rot=0,
				cld={}
			}
			add(target.cld,att)
			selected=att
		end 
	else
		if (btn(⬅️) or btn(⬆️)) selected.rot+=0.025
		if (btn(➡️) or btn(⬇️)) selected.rot-=0.025
		if (rel_btn(❎)) selected=nil
	end
end

function game_update()
	if selected==nil then
		if (btn(⬅️)) pl.x -= 1
		if (btn(➡️)) pl.x += 1
		if (btn(⬆️)) pl.y -= 1
		if (btn(⬇️)) pl.y += 1
		pl.x=clamp(pl.x,mdata.minx,mdata.maxx)
		pl.y=clamp(pl.y,mdata.miny,mdata.maxy)
	end
	
	if (phase==1) pln_update()
end

function draw_bomb()
	local lst=bmb_to_list()
	for ent in all(lst) do
		doblink = (ent==selected) or ((ent==target) and (selected==nil))
	
		if doblink then
			local blnk=flr((t()%1)*4)%2==0
			if blnk then
				pal({1,1,5,5,5,6,7,13,6,7,7,6,13,6,7,1})
			end
		end
		local sp=types[ent.id].sp
		if sp==0 then
			spr(12,ent.x-8,ent.y-8,2,2)
		else
			spr(sp,ent.x-ent.rad,ent.y-ent.rad)
			spr(3,ent.ax-1,ent.ay-1)
		end
		pal()
	end
end

function game_draw()
	cls(0)
	camera(pl.x-64,pl.y-64)
	map(mdata[1],mdata[2],0,0,mdata[3],mdata[4])
	
	draw_bomb()
	
	spr(0,pl.x-4,pl.y-4)
	
	draw_debug()
end
-->8

-->8
-- util
function clamp(val,minv,maxv)
	return min(maxv,max(minv,val))
end

function dist(ax,ay,bx,by)
	local dx=bx-ax
	local dy=by-ay
	return sqrt(dx*dx+dy*dy)
end

dbgstrs={}
function dbg(str)
	add(dbgstrs,str)
end

function draw_debug()
	camera()
	for s in all(dbgstrs) do
		print(s)
	end
	dbgstrs={}
end

btnstate={}
btnstate[❎]={cur=false,prev=false}
	
function tick_btn()
	local st=btnstate[❎]
	st.prev=st.cur
	st.cur=btn(❎)
end

function rel_btn(b)
	local st=btnstate[b]
	return st.cur==true and st.prev==false
end
-->8
-- state dispatch

gstate=1
states={
	{menu_update, menu_draw},
	{game_update, game_draw}
}

function _update()
	tick_btn()
	states[gstate][1]()
end

function _draw()
	states[gstate][2]()
end
__gfx__
000bb000dddddddd555555550b000000000000000000000000000000000000000000000000000000000650000000000000000888888000000000000000000000
000bb000dd0000dd55555555b3b00000000000000000000000000000000000000000000000000000056966500000000000088ffffff880000000000000000000
000bb000d000000d555555550b0000000000000000000000000000000000000000000000000000000699996000000000008ffffffffff8000000066600000000
bbb00bbbd000000d5555555500000000000000000000000000000000000000000000000000000000569999960000000008ffffeeeeffff800000677700000000
bbb00bbbd000000d5555555500000000000000000000000000000000000000000000000000000000699999650000000008feeeffffeeef800006777700000000
000bb000d000000d555555550000000000000000000000000000000000000000000000000000000006999960000000008ffffffffffffff80067777700000000
000bb000dd0000dd555555550000000000000000000000000000000000000000000000000000000005669650000000008f888f8ff8f888f80067777700000000
000bb000dddddddd555555550000000000000000000000000000000000000000000000000000000000056000000000008ff8ff88f8ff8ff80067777700000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ff8ff8f88ff8ff80000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ff8ff8ff8ff8ff80000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ffffffffffffff80000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008feeeffffeeef800000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ffffeeeeffff800000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ffffffffff8000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088ffffff880000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000888888000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
