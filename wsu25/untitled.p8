pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
-- menu!
autostart=true
levelid=1

function menu_update()
	if (btn(❎) or autostart) begin_game(levelid)
end

function menu_draw()
	cls(0)
	?"press ❎ to start"
end

-->8
-- game!

types={
	{sp=10} -- 1: blade
}

-- state
pl={x=64,y=64}
levels={
	{0,0,16,16}
}
mdata=nil
--1=planning,2=sim
phase=1
bmb={rot=0,rad=8,cld={}}

function set_level(id)
	mdata=levels[id]
	mdata.minx=10
	mdata.miny=10
	mdata.maxx=mdata[3]*8-10
	mdata.maxy=mdata[4]*8-10
	bmb.x=(mdata.minx+mdata.maxx)/2
	bmb.y=(mdata.miny+mdata.maxy)/2
	bmb.cld={}
	phase=1
end

-- cb
function begin_game(id)
	gstate=2
	set_level(id)
end

function pln_update()
	-- determine target
	-- highlight target
	-- click to create child
	-- edit child
end

function game_update()
	if (btn(⬅️)) pl.x -= 1
	if (btn(➡️)) pl.x += 1
	if (btn(⬆️)) pl.y -= 1
	if (btn(⬇️)) pl.y += 1
	pl.x=clamp(pl.x,mdata.minx,mdata.maxx)
	pl.y=clamp(pl.y,mdata.miny,mdata.maxy)
	
	if (phase==1) pln_update()
end

function draw_bomb()
	spr(12,bmb.x-8,bmb.y-8,2,2)
end

function draw_attach()
	spr(14,40,40)
	spr(14,46,40,1,1,true)
	spr(14,40,46,1,1,false,true)
	spr(14,46,46,1,1,true,true)
end

function game_draw()
	cls(0)
	camera(pl.x-64,pl.y-64)
	map(mdata[1],mdata[2],0,0,mdata[3],mdata[4])
	
	draw_bomb()
	
	spr(0,pl.x-4,pl.y-4)
end
-->8

-->8
-- util
function clamp(val,minv,maxv)
	return min(maxv,max(minv,val))
end
-->8
-- state dispatch

gstate=1
states={
	{menu_update, menu_draw},
	{game_update, game_draw}
}

function _update()
	states[gstate][1]()
end

function _draw()
	states[gstate][2]()
end
__gfx__
000bb000dddddddd5555555500000000000000000000000000000000000000000000000000000000000650000000000000000888888000000000000000000000
000bb000dd0000dd5555555500000000000000000000000000000000000000000000000000000000056d66500000000000088ffffff880000000000000000000
000bb000d000000d555555550000000000000000000000000000000000000000000000000000000006dddd6000000000008ffffffffff8000000066600000000
bbb00bbbd000000d555555550000000000000000000000000000000000000000000000000000000056ddddd60000000008ffffeeeeffff800000677700000000
bbb00bbbd000000d55555555000000000000000000000000000000000000000000000000000000006ddddd650000000008feeeffffeeef800006777700000000
000bb000d000000d555555550000000000000000000000000000000000000000000000000000000006dddd60000000008ffffffffffffff80067777700000000
000bb000dd0000dd55555555000000000000000000000000000000000000000000000000000000000566d650000000008f888f8ff8f888f80067777700000000
000bb000dddddddd555555550000000000000000000000000000000000000000000000000000000000056000000000008ff8ff88f8ff8ff80067777700000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ff8ff8f88ff8ff80000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ff8ff8ff8ff8ff80000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ffffffffffffff80000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008feeeffffeeef800000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ffffeeeeffff800000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008ffffffffff8000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088ffffff880000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000888888000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202020202020202020202020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
